<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Santiniketan Mess Calculator - DevSan</title>
    <meta name="description" content="Transparent hostel bill management & calculation for mess facilities. Calculate meal rates, establishment charges, and individual bills.">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #4A90E2;
            --primary-dark: #357ABD;
            --success: #27AE60;
            --danger: #E74C3C;
            --warning: #F39C12;
            --background: #F5F7FA;
            --card: #FFFFFF;
            --text: #2C3E50;
            --text-muted: #7F8C8D;
            --border: #E1E8ED;
            --shadow: rgba(0, 0, 0, 0.1);
            --radius: 12px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header-icon {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 8px;
            color: var(--text);
        }

        .header p {
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        .card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .card-header {
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-description {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        input[type="text"],
        input[type="number"],
        button {
            font-family: inherit;
            font-size: 14px;
        }

        input[type="text"],
        input[type="number"] {
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            width: 100%;
            transition: all 0.2s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }

        .btn-outline:hover {
            background: var(--background);
            border-color: var(--primary);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .btn-lg {
            padding: 14px 28px;
            font-size: 1rem;
        }

        .btn-icon {
            padding: 8px;
            width: 36px;
            height: 36px;
            justify-content: center;
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            background: var(--background);
            color: var(--text);
            margin-left: 8px;
        }

        .badge-secondary {
            background: #E8E8E8;
        }

        .badge-outline {
            background: transparent;
            border: 1px solid var(--border);
        }

        .member-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .member-item:hover {
            box-shadow: 0 2px 8px var(--shadow);
        }

        .member-name {
            flex: 1;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 120px;
        }

        .member-inputs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            flex: 2;
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .input-group label {
            margin: 0;
            font-size: 0.8rem;
            color: var(--text-muted);
            white-space: nowrap;
        }

        .input-group input {
            width: 70px;
            padding: 6px 8px;
        }

        .grid {
            display: grid;
            gap: 16px;
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .grid-4 {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }

        .flex {
            display: flex;
        }

        .flex-wrap {
            flex-wrap: wrap;
        }

        .gap-2 {
            gap: 8px;
        }

        .gap-3 {
            gap: 12px;
        }

        .justify-center {
            justify-content: center;
        }

        .items-center {
            align-items: center;
        }

        .space-between {
            justify-content: space-between;
        }

        .text-center {
            text-align: center;
        }

        .text-muted {
            color: var(--text-muted);
        }

        .text-success {
            color: var(--success);
        }

        .text-danger {
            color: var(--danger);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        th {
            text-align: left;
            padding: 12px 8px;
            font-weight: 600;
            border-bottom: 2px solid var(--border);
        }

        th.text-right {
            text-align: right;
        }

        td {
            padding: 12px 8px;
            border-bottom: 1px solid var(--border);
        }

        td.text-right {
            text-align: right;
        }

        tr:hover {
            background: rgba(74, 144, 226, 0.05);
        }

        .stat-card {
            background: rgba(74, 144, 226, 0.08);
            padding: 16px;
            border-radius: 8px;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--card);
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--shadow);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .toast.show {
            display: flex;
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--danger);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
            }
            to {
                transform: translateX(0);
            }
        }

        .hidden {
            display: none !important;
        }

        .separator {
            height: 1px;
            background: var(--border);
            margin: 20px 0;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin: 20px 0;
        }

        .comparison-item {
            padding: 12px;
            background: rgba(74, 144, 226, 0.05);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .history-item:hover {
            box-shadow: 0 2px 8px var(--shadow);
        }

        footer {
            text-align: center;
            padding: 24px;
            margin-top: 40px;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }

            .header p {
                font-size: 0.95rem;
            }

            .member-item {
                flex-direction: column;
                align-items: stretch;
            }

            .member-inputs {
                width: 100%;
            }

            .comparison-grid {
                grid-template-columns: 1fr;
            }

            .mobile-details {
                display: block;
                font-size: 0.75rem;
                color: var(--text-muted);
                margin-top: 8px;
            }

            .hide-mobile {
                display: none;
            }
        }

        @media (min-width: 769px) {
            .mobile-details {
                display: none;
            }
        }

        @media print {
            @page {
                size: A4;
                margin: 1cm;
            }

            body {
                background: white;
                padding: 0;
            }

            .no-print {
                display: none !important;
            }

            .print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 30px;
            }

            .card {
                box-shadow: none;
                border: 1px solid #e0e0e0;
                page-break-inside: avoid;
            }

            .btn {
                display: none;
            }
        }

        .print-header {
            display: none;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .checkbox-label:hover {
            background: var(--background);
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: -9999px;
        }

        .overflow-auto {
            overflow-x: auto;
        }

        .overflow-auto::-webkit-scrollbar {
            height: 8px;
        }

        .overflow-auto::-webkit-scrollbar-track {
            background: var(--background);
        }

        .overflow-auto::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        .overflow-auto::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                    <line x1="3" y1="9" x2="21" y2="9"/>
                    <line x1="9" y1="21" x2="9" y2="9"/>
                </svg>
            </div>
            <h1>Santiniketan Mess Calculator</h1>
            <p>Transparent hostel bill management & calculation</p>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <span style="font-weight: bold;">&#9776;</span>
                    Members Management
                </h2>
                <p class="card-description">Add and manage mess members</p>
            </div>
            
            <div class="flex gap-2" style="margin-bottom: 16px;">
                <input type="text" id="newMemberName" placeholder="Member name" style="flex: 1;" onkeypress="if(event.key === 'Enter') addMember()">
                <label class="checkbox-label">
                    <input type="checkbox" id="isGuestMember">
                    <span style="font-size: 0.85rem;">Guest Only</span>
                </label>
                <button class="btn btn-primary" onclick="addMember()">
                    <span style="font-weight: bold;">+</span>
                    Add
                </button>
            </div>

            <div id="membersList"></div>

            <div class="flex flex-wrap gap-2" style="margin-top: 16px;">
                <button class="btn btn-outline" onclick="exportData()">
                    <span style="font-weight: bold;">&#8595;</span>
                    Export
                </button>
                <div class="file-input-wrapper">
                    <button class="btn btn-outline">
                        <span style="font-weight: bold;">&#8593;</span>
                        Import
                    </button>
                    <input type="file" id="importFile" accept=".json" onchange="importData(event)">
                </div>
                <button class="btn btn-outline" onclick="downloadTemplate()">
                    <span style="font-weight: bold;">&#9776;</span>
                    Download Template
                </button>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <span style="font-weight: bold;">Rs.</span>
                    Expenses
                </h2>
                <p class="card-description">Enter all mess expenses for the period</p>
            </div>
            
            <div class="grid grid-2">
                <div>
                    <label for="riceCost">Rice Cost (₹)</label>
                    <input type="number" id="riceCost" value="0" onfocus="handleInputFocus(this)" onchange="handleInputChange(this)">
                </div>
                <div>
                    <label for="marketingCost">Marketing Cost (₹)</label>
                    <input type="number" id="marketingCost" value="0" onfocus="handleInputFocus(this)" onchange="handleInputChange(this)">
                </div>
                <div>
                    <label for="gasCost">Gas Cost (₹)</label>
                    <input type="number" id="gasCost" value="0" onfocus="handleInputFocus(this)" onchange="handleInputChange(this)">
                </div>
                <div>
                    <label for="paperCost">Paper Cost (₹)</label>
                    <input type="number" id="paperCost" value="0" onfocus="handleInputFocus(this)" onchange="handleInputChange(this)">
                </div>
                <div>
                    <label for="otherCosts">Other Costs (₹)</label>
                    <input type="number" id="otherCosts" value="0" onfocus="handleInputFocus(this)" onchange="handleInputChange(this)">
                </div>
                <div>
                    <label for="boundMeal">Bound Meal (Minimum Meals)</label>
                    <input type="number" id="boundMeal" value="0" onfocus="handleInputFocus(this)" onchange="handleInputChange(this)">
                </div>
                <div>
                    <label for="totalCookCharge">Total Cook Charge (₹) - Optional</label>
                    <input type="number" id="totalCookCharge" value="0" onfocus="handleInputFocus(this)" oninput="updateCookCharge('total')">
                </div>
                <div>
                    <label for="cookRatePerHead">Cook Rate per Head (₹) - Optional</label>
                    <input type="number" id="cookRatePerHead" value="0" onfocus="handleInputFocus(this)" oninput="updateCookCharge('perHead')">
                </div>
            </div>
        </div>

        <div class="flex flex-wrap justify-center gap-3" style="margin-bottom: 24px;">
            <button class="btn btn-primary btn-lg" onclick="calculateBills()">
                <span style="font-weight: bold;">=</span>
                Calculate Bills
            </button>
            <button class="btn btn-outline btn-lg" onclick="toggleHistory()">
                <span style="font-weight: bold;">&#9776;</span>
                History (<span id="historyCount">0</span>)
            </button>
            <button class="btn btn-outline btn-lg hidden" id="compareBtn" onclick="toggleComparison()">
                <span style="font-weight: bold;">&#8645;</span>
                Compare
            </button>
        </div>

        <div class="card hidden" id="historySection">
            <div class="card-header">
                <div class="flex space-between items-center">
                    <div>
                        <h2 class="card-title">Calculation History</h2>
                        <p class="card-description">View and load past calculations</p>
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="clearHistory()">Clear All</button>
                </div>
            </div>
            <div id="historyList"></div>
        </div>

        <div class="card hidden" id="comparisonSection">
            <div class="card-header">
                <h2 class="card-title">
                    <span style="font-weight: bold;">&#8645;</span>
                    Monthly Comparison
                </h2>
                <p class="card-description">Compare current calculation with previous month</p>
            </div>
            <div>
                <label>Select Previous Month to Compare</label>
                <div id="comparisonButtons" class="grid grid-2" style="margin-top: 12px; margin-bottom: 20px;"></div>
            </div>
            <div id="comparisonContent"></div>
        </div>

        <div id="resultsSection" class="hidden">
            <div class="print-header">
                <h1>Mess Bill <span id="printDate"></span></h1>
                <p style="margin-top: 8px;">Santiniketan Mess Calculator</p>
            </div>

            <div class="flex flex-wrap justify-center gap-3 no-print" style="margin-bottom: 24px;">
                <button class="btn btn-outline btn-lg" onclick="printResults()">
                    <span style="font-weight: bold;">&#9113;</span>
                    Print / Save as PDF
                </button>
                <button class="btn btn-success btn-lg" onclick="shareViaWhatsApp()">
                    <span style="font-weight: bold;">&#9742;</span>
                    Share via WhatsApp
                </button>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <span style="font-weight: bold;">=</span>
                        Calculation Overview
                    </h2>
                    <p class="card-description">Key metrics for this billing period</p>
                </div>
                <div class="grid grid-4">
                    <div class="stat-card">
                        <div class="stat-label">Total Members</div>
                        <div class="stat-value" id="totalMembers">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Meals</div>
                        <div class="stat-value" id="totalMeals">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Meal Rate</div>
                        <div class="stat-value" id="mealRate">Rs. 0.00</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Est. Charge</div>
                        <div class="stat-value" id="estCharge">Rs. 0.00</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title" style="font-size: 1.2rem;">Individual Bills</h2>
                    <p class="card-description">Detailed breakdown</p>
                </div>
                <div class="overflow-auto">
                    <table id="billsTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th class="text-right hide-mobile">Actual Meals</th>
                                <th class="text-right hide-mobile">Meals</th>
                                <th class="text-right hide-mobile">M.Cost</th>
                                <th class="text-right hide-mobile">Est.</th>
                                <th class="text-right hide-mobile">Guest</th>
                                <th class="text-right hide-mobile">Fine</th>
                                <th class="text-right hide-mobile">Dep.</th>
                                <th class="text-right">Total</th>
                                <th class="text-right">Outstanding</th>
                            </tr>
                        </thead>
                        <tbody id="billsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <footer>
            Crafted by <strong>DevSan (Sandipan Bera)</strong>
        </footer>
    </div>

    <div id="toast" class="toast">
        <span id="toastMessage"></span>
    </div>

    <script>
        let members = [];
        let history = [];
        let results = null;
        let overview = null;
        let comparisonEntry = null;

        function init() {
            const savedMembers = localStorage.getItem('hostel-members');
            if (savedMembers) {
                try {
                    members = JSON.parse(savedMembers);
                    renderMembers();
                } catch (e) {
                    console.error('Failed to load members', e);
                }
            }

            const savedHistory = localStorage.getItem('hostel-calculation-history');
            if (savedHistory) {
                try {
                    history = JSON.parse(savedHistory);
                    updateHistoryCount();
                } catch (e) {
                    console.error('Failed to load history', e);
                }
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.className = 'toast show ' + type;
            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        }

        function handleInputFocus(input) {
            if (input.value === '0' || input.value === '') {
                input.value = '';
            }
        }

        function handleInputChange(input) {
            const value = input.value.replace(/^0+(?=\d)/, '');
            input.value = value || '0';
        }

        function formatDate(date, format = 'MMM, yyyy') {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const d = new Date(date);
            
            if (format === 'MMM, yyyy') {
                return `${months[d.getMonth()]}, ${d.getFullYear()}`;
            } else if (format === 'MMM, yyyy - hh:mm a') {
                const hours = d.getHours();
                const minutes = d.getMinutes();
                const ampm = hours >= 12 ? 'pm' : 'am';
                const hour12 = hours % 12 || 12;
                return `${months[d.getMonth()]}, ${d.getFullYear()} - ${hour12}:${minutes.toString().padStart(2, '0')} ${ampm}`;
            }
            return d.toLocaleDateString();
        }

        function addMember() {
            const nameInput = document.getElementById('newMemberName');
            const isGuestInput = document.getElementById('isGuestMember');
            const name = nameInput.value.trim();

            if (!name) {
                showToast('Please enter a member name', 'error');
                return;
            }

            if (members.some(m => m.name.toLowerCase() === name.toLowerCase())) {
                showToast('Member already exists', 'error');
                return;
            }

            members.push({
                name: name,
                meals: 0,
                deposits: 0,
                guest: 0,
                fine: 0,
                isGuest: isGuestInput.checked
            });

            nameInput.value = '';
            isGuestInput.checked = false;
            saveMembersToStorage();
            renderMembers();
            showToast('Member added');
        }

        function removeMember(name) {
            members = members.filter(m => m.name !== name);
            saveMembersToStorage();
            renderMembers();
            showToast('Member removed');
        }

        function updateMember(name, field, value) {
            const member = members.find(m => m.name === name);
            if (member) {
                member[field] = value;
                saveMembersToStorage();
            }
        }

        function renderMembers() {
            const container = document.getElementById('membersList');
            
            if (members.length === 0) {
                container.innerHTML = '<div class="empty-state">No members added yet</div>';
                return;
            }

            container.innerHTML = members.map(member => `
                <div class="member-item">
                    <div class="member-name">
                        ${member.name}
                        ${member.isGuest ? '<span class="badge badge-secondary">Guest</span>' : ''}
                    </div>
                    <div class="member-inputs">
                        ${!member.isGuest ? `
                            <div class="input-group">
                                <label>Meals:</label>
                                <input type="number" value="${member.meals || ''}" 
                                    onfocus="handleInputFocus(this)"
                                    onchange="updateMember('${member.name}', 'meals', parseFloat(this.value) || 0)">
                            </div>
                        ` : ''}
                        <div class="input-group">
                            <label>Dep:</label>
                            <input type="number" value="${member.deposits || ''}"
                                onfocus="handleInputFocus(this)"
                                onchange="updateMember('${member.name}', 'deposits', parseFloat(this.value) || 0)">
                        </div>
                        <div class="input-group">
                            <label>Guest:</label>
                            <input type="number" value="${member.guest || ''}"
                                onfocus="handleInputFocus(this)"
                                onchange="updateMember('${member.name}', 'guest', parseFloat(this.value) || 0)">
                        </div>
                        <div class="input-group">
                            <label>Fine:</label>
                            <input type="number" value="${member.fine || ''}"
                                onfocus="handleInputFocus(this)"
                                onchange="updateMember('${member.name}', 'fine', parseFloat(this.value) || 0)">
                        </div>
                    </div>
                    <button class="btn btn-outline btn-icon" onclick="removeMember('${member.name}')">
                        <span style="font-weight: bold;">X</span>
                    </button>
                </div>
            `).join('');
        }

        function saveMembersToStorage() {
            localStorage.setItem('hostel-members', JSON.stringify(members));
        }

        function updateCookCharge(mode) {
            const totalInput = document.getElementById('totalCookCharge');
            const perHeadInput = document.getElementById('cookRatePerHead');
            const nonGuestCount = members.filter(m => !m.isGuest).length;

            if (mode === 'total') {
                const total = parseFloat(totalInput.value) || 0;
                if (nonGuestCount > 0) {
                    perHeadInput.value = (total / nonGuestCount).toFixed(2);
                } else {
                    perHeadInput.value = '0';
                }
            } else {
                const perHead = parseFloat(perHeadInput.value) || 0;
                totalInput.value = (perHead * nonGuestCount).toFixed(2);
            }
        }

        function exportData() {
            if (members.length === 0) {
                showToast('No members to export', 'error');
                return;
            }

            const dataStr = JSON.stringify(members, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'mess-members.json';
            link.click();
            showToast('Data exported');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (Array.isArray(data)) {
                        members = data;
                        saveMembersToStorage();
                        renderMembers();
                        showToast('Data imported successfully');
                    } else {
                        showToast('Invalid file format', 'error');
                    }
                } catch (error) {
                    showToast('Failed to import data', 'error');
                }
            };
            reader.readAsText(file);
        }

        function downloadTemplate() {
            const defaultMembers = [
                { name: 'Member 1', meals: 0, deposits: 0, guest: 0, fine: 0, isGuest: false },
                { name: 'Member 2', meals: 0, deposits: 0, guest: 0, fine: 0, isGuest: false },
                { name: 'Member 3', meals: 0, deposits: 0, guest: 0, fine: 0, isGuest: false }
            ];
            const dataStr = JSON.stringify(defaultMembers, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'default-members.json';
            link.click();
            showToast('Default members template downloaded');
        }

        function calculateBills() {
            if (members.length === 0) {
                showToast('Please add at least one member', 'error');
                return;
            }

            const nonGuestMembers = members.filter(m => !m.isGuest);
            
            if (nonGuestMembers.length === 0) {
                showToast('At least one non-guest member is required', 'error');
                return;
            }

            const riceCost = parseFloat(document.getElementById('riceCost').value) || 0;
            const marketingCost = parseFloat(document.getElementById('marketingCost').value) || 0;
            const gasCost = parseFloat(document.getElementById('gasCost').value) || 0;
            const paperCost = parseFloat(document.getElementById('paperCost').value) || 0;
            const otherCosts = parseFloat(document.getElementById('otherCosts').value) || 0;
            const totalCookCharge = parseFloat(document.getElementById('totalCookCharge').value) || 0;
            const boundMeal = parseFloat(document.getElementById('boundMeal').value) || 0;

            const totalGuestMealCharge = members.reduce((sum, m) => sum + m.guest, 0);

            const effectiveMembersData = members.map(m => ({
                ...m,
                effectiveMeals: m.isGuest ? 0 : Math.max(m.meals, boundMeal)
            }));

            const totalMeals = effectiveMembersData.reduce((sum, m) => sum + m.effectiveMeals, 0);

            if (totalMeals === 0) {
                showToast('Total meals cannot be zero', 'error');
                return;
            }

            const totalMarketing = riceCost + marketingCost + gasCost;
            const totalOthers = totalCookCharge + paperCost + otherCosts;

            const mealRate = (totalMarketing - totalGuestMealCharge) / totalMeals;
            const establishmentCharge = totalOthers / nonGuestMembers.length;

            results = effectiveMembersData.map(member => {
                const mealCost = member.effectiveMeals * mealRate;
                const estCharge = member.isGuest ? 0 : establishmentCharge;
                const totalBill = mealCost + estCharge + member.guest + member.fine;
                const outstanding = Math.round(totalBill - member.deposits);

                return {
                    ...member,
                    mealCost,
                    establishmentCharge: estCharge,
                    totalBill,
                    outstanding
                };
            });

            overview = {
                totalMeals,
                mealRate,
                totalMembers: nonGuestMembers.length,
                establishmentCharge
            };

            const newHistoryEntry = {
                id: Date.now().toString(),
                date: new Date().toISOString(),
                members: JSON.parse(JSON.stringify(members)),
                expenses: {
                    riceCost,
                    marketingCost,
                    gasCost,
                    paperCost,
                    otherCosts,
                    totalCookCharge,
                    boundMeal
                },
                results,
                overview
            };

            history = [newHistoryEntry, ...history].slice(0, 10);
            localStorage.setItem('hostel-calculation-history', JSON.stringify(history));
            updateHistoryCount();

            renderResults();
            showToast('Bills calculated successfully');

            setTimeout(() => {
                document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
            }, 100);

            if (history.length > 1) {
                document.getElementById('compareBtn').classList.remove('hidden');
            }
        }

        function renderResults() {
            if (!results || !overview) return;

            document.getElementById('resultsSection').classList.remove('hidden');

            document.getElementById('totalMembers').textContent = overview.totalMembers;
            document.getElementById('totalMeals').textContent = overview.totalMeals;
            document.getElementById('mealRate').textContent = 'Rs. ' + overview.mealRate.toFixed(2);
            document.getElementById('estCharge').textContent = 'Rs. ' + overview.establishmentCharge.toFixed(2);
            document.getElementById('printDate').textContent = formatDate(new Date());

            const tbody = document.getElementById('billsTableBody');
            tbody.innerHTML = results.map(member => `
                <tr>
                    <td>
                        <div style="font-weight: 500;">${member.name}</div>
                        <div style="display: flex; gap: 4px; margin-top: 4px;">
                            ${member.isGuest ? '<span class="badge badge-secondary" style="font-size: 0.65rem;">G</span>' : ''}
                            ${!member.isGuest && member.effectiveMeals > member.meals ? '<span class="badge badge-outline" style="font-size: 0.65rem;">Min</span>' : ''}
                        </div>
                        <div class="mobile-details">
                            ${!member.isGuest ? `M: ${member.effectiveMeals} • C: Rs. ${member.mealCost.toFixed(2)} • E: Rs. ${member.establishmentCharge.toFixed(2)}<br>` : ''}
                            G: Rs. ${member.guest.toFixed(2)} • F: Rs. ${member.fine.toFixed(2)} • D: Rs. ${member.deposits.toFixed(2)}
                        </div>
                    </td>
                    <td class="text-right hide-mobile">${member.isGuest ? '-' : member.meals}</td>
                    <td class="text-right hide-mobile">${member.isGuest ? '-' : member.effectiveMeals}</td>
                    <td class="text-right hide-mobile">${member.isGuest ? '-' : 'Rs. ' + member.mealCost.toFixed(2)}</td>
                    <td class="text-right hide-mobile">${member.isGuest ? '-' : 'Rs. ' + member.establishmentCharge.toFixed(2)}</td>
                    <td class="text-right hide-mobile">Rs. ${member.guest.toFixed(2)}</td>
                    <td class="text-right hide-mobile">${member.fine > 0 ? '<span class="text-danger">Rs. ' + member.fine.toFixed(2) + '</span>' : '-'}</td>
                    <td class="text-right hide-mobile">Rs. ${member.deposits.toFixed(2)}</td>
                    <td class="text-right" style="font-weight: 600;">Rs. ${member.totalBill.toFixed(2)}</td>
                    <td class="text-right ${member.outstanding > 0 ? 'text-danger' : 'text-success'}" style="font-weight: bold;">
                        Rs. ${member.outstanding.toFixed(2)}
                    </td>
                </tr>
            `).join('');
        }

        function printResults() {
            const currentDate = new Date();
            const originalTitle = document.title;
            document.title = `Mess Bill_${formatDate(currentDate)}_DevSan`;
            
            window.print();
            
            setTimeout(() => {
                document.title = originalTitle;
            }, 1000);
            
            showToast('Opening print dialog');
        }

        function shareViaWhatsApp() {
            if (!results || !overview) return;

            const currentDate = new Date();
            let message = `*Mess Bill Summary - ${formatDate(currentDate)}*\n\n`;
            message += `*Overview:*\n`;
            message += `Total Members: ${overview.totalMembers}\n`;
            message += `Total Meals: ${overview.totalMeals}\n`;
            message += `Meal Rate: Rs. ${overview.mealRate.toFixed(2)}\n`;
            message += `Est. Charge: Rs. ${overview.establishmentCharge.toFixed(2)}\n\n`;
            message += `*Individual Bills:*\n`;
            message += `================================\n`;

            results.forEach((member) => {
                message += `\n*${member.name}*${member.isGuest ? ' (Guest)' : ''}\n`;
                if (!member.isGuest) {
                    message += `Meals: ${member.effectiveMeals} | Cost: Rs. ${member.mealCost.toFixed(2)}\n`;
                    message += `Est. Charge: Rs. ${member.establishmentCharge.toFixed(2)}\n`;
                }
                if (member.guest > 0) message += `Guest: Rs. ${member.guest.toFixed(2)}\n`;
                if (member.fine > 0) message += `Fine: Rs. ${member.fine.toFixed(2)}\n`;
                message += `Deposits: Rs. ${member.deposits.toFixed(2)}\n`;
                message += `*Total: Rs. ${member.totalBill.toFixed(2)}*\n`;
                message += `*Outstanding: Rs. ${member.outstanding.toFixed(2)}*\n`;
            });

            message += `\n================================\n`;
            message += `Crafted by DevSan`;

            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            showToast('Opening WhatsApp');
        }

        function updateHistoryCount() {
            document.getElementById('historyCount').textContent = history.length;
        }

        function toggleHistory() {
            const section = document.getElementById('historySection');
            section.classList.toggle('hidden');
            
            if (!section.classList.contains('hidden')) {
                renderHistory();
            }
        }

        function renderHistory() {
            const container = document.getElementById('historyList');
            
            if (history.length === 0) {
                container.innerHTML = '<div class="empty-state">No history available</div>';
                return;
            }

            container.innerHTML = history.map(entry => `
                <div class="history-item">
                    <div>
                        <div style="font-weight: 500; font-size: 0.9rem;">
                            ${formatDate(new Date(entry.date), 'MMM, yyyy - hh:mm a')}
                        </div>
                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">
                            ${entry.results.length} members • Rs. ${entry.overview.mealRate.toFixed(2)}/meal
                        </div>
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="loadHistoryEntry('${entry.id}')">
                        Load
                    </button>
                </div>
            `).join('');
        }

        function loadHistoryEntry(id) {
            const entry = history.find(h => h.id === id);
            if (!entry) return;

            members = entry.members;
            document.getElementById('riceCost').value = entry.expenses.riceCost;
            document.getElementById('marketingCost').value = entry.expenses.marketingCost;
            document.getElementById('gasCost').value = entry.expenses.gasCost;
            document.getElementById('paperCost').value = entry.expenses.paperCost;
            document.getElementById('otherCosts').value = entry.expenses.otherCosts;
            document.getElementById('totalCookCharge').value = entry.expenses.totalCookCharge;
            document.getElementById('boundMeal').value = entry.expenses.boundMeal;

            saveMembersToStorage();
            renderMembers();

            results = entry.results;
            overview = entry.overview;
            renderResults();

            document.getElementById('historySection').classList.add('hidden');
            showToast('History loaded');

            setTimeout(() => {
                document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        function clearHistory() {
            if (confirm('Are you sure you want to clear all history?')) {
                history = [];
                localStorage.removeItem('hostel-calculation-history');
                updateHistoryCount();
                renderHistory();
                showToast('History cleared');
                document.getElementById('compareBtn').classList.add('hidden');
            }
        }

        function toggleComparison() {
            const section = document.getElementById('comparisonSection');
            section.classList.toggle('hidden');
            
            if (!section.classList.contains('hidden')) {
                renderComparisonButtons();
            }
        }

        function renderComparisonButtons() {
            const container = document.getElementById('comparisonButtons');
            const compareHistory = history.slice(1);

            if (compareHistory.length === 0) {
                container.innerHTML = '<div class="empty-state">No previous calculations to compare</div>';
                return;
            }

            container.innerHTML = compareHistory.map(entry => `
                <button class="btn ${comparisonEntry && comparisonEntry.id === entry.id ? 'btn-primary' : 'btn-outline'}" 
                    onclick="selectComparisonEntry('${entry.id}')" 
                    style="justify-content: flex-start;">
                    ${formatDate(new Date(entry.date))} - Rs. ${entry.overview.mealRate.toFixed(2)}/meal
                </button>
            `).join('');
        }

        function selectComparisonEntry(id) {
            comparisonEntry = history.find(h => h.id === id);
            renderComparisonButtons();
            renderComparison();
        }

        function renderComparison() {
            if (!comparisonEntry || !overview) return;

            const container = document.getElementById('comparisonContent');
            
            const mealRateChange = overview.mealRate - comparisonEntry.overview.mealRate;
            const mealRatePercent = (mealRateChange / comparisonEntry.overview.mealRate * 100).toFixed(1);
            const estChargeChange = overview.establishmentCharge - comparisonEntry.overview.establishmentCharge;
            const estChargePercent = (estChargeChange / comparisonEntry.overview.establishmentCharge * 100).toFixed(1);
            const mealsChange = overview.totalMeals - comparisonEntry.overview.totalMeals;

            container.innerHTML = `
                <div class="separator"></div>
                <div class="comparison-grid">
                    <div>
                        <h3 style="font-weight: 600; margin-bottom: 16px;">Current Month</h3>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <div class="comparison-item">
                                <span style="font-size: 0.9rem;">Date:</span>
                                <span style="font-weight: 500;">${formatDate(new Date())}</span>
                            </div>
                            <div class="comparison-item">
                                <span style="font-size: 0.9rem;">Total Members:</span>
                                <span style="font-weight: 500;">${overview.totalMembers}</span>
                            </div>
                            <div class="comparison-item">
                                <span style="font-size: 0.9rem;">Total Meals:</span>
                                <span style="font-weight: 500;">${overview.totalMeals}</span>
                            </div>
                            <div class="comparison-item">
                                <span style="font-size: 0.9rem;">Meal Rate:</span>
                                <span style="font-weight: 500;">Rs. ${overview.mealRate.toFixed(2)}</span>
                            </div>
                            <div class="comparison-item">
                                <span style="font-size: 0.9rem;">Est. Charge:</span>
                                <span style="font-weight: 500;">Rs. ${overview.establishmentCharge.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 style="font-weight: 600; margin-bottom: 16px;">Previous Month</h3>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <div class="comparison-item">
                                <span style="font-size: 0.9rem;">Date:</span>
                                <span style="font-weight: 500;">${formatDate(new Date(comparisonEntry.date))}</span>
                            </div>
                            <div class="comparison-item">
                                <span style="font-size: 0.9rem;">Total Members:</span>
                                <span style="font-weight: 500;">${comparisonEntry.overview.totalMembers}</span>
                            </div>
                            <div class="comparison-item">
                                <span style="font-size: 0.9rem;">Total Meals:</span>
                                <span style="font-weight: 500;">${comparisonEntry.overview.totalMeals}</span>
                            </div>
                            <div class="comparison-item">
                                <span style="font-size: 0.9rem;">Meal Rate:</span>
                                <span style="font-weight: 500;">Rs. ${comparisonEntry.overview.mealRate.toFixed(2)}</span>
                            </div>
                            <div class="comparison-item">
                                <span style="font-size: 0.9rem;">Est. Charge:</span>
                                <span style="font-weight: 500;">Rs. ${comparisonEntry.overview.establishmentCharge.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="separator"></div>
                <div>
                    <h3 style="font-weight: 600; margin-bottom: 16px;">Changes</h3>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <div class="comparison-item">
                            <span style="font-size: 0.9rem;">Meal Rate Change:</span>
                            <span class="${mealRateChange > 0 ? 'text-danger' : mealRateChange < 0 ? 'text-success' : ''}" style="font-weight: bold;">
                                ${mealRateChange > 0 ? '↑' : mealRateChange < 0 ? '↓' : '→'} 
                                Rs. ${Math.abs(mealRateChange).toFixed(2)}
                                ${mealRateChange !== 0 ? `<span style="font-size: 0.75rem; margin-left: 8px;">(${mealRatePercent}%)</span>` : ''}
                            </span>
                        </div>
                        <div class="comparison-item">
                            <span style="font-size: 0.9rem;">Est. Charge Change:</span>
                            <span class="${estChargeChange > 0 ? 'text-danger' : estChargeChange < 0 ? 'text-success' : ''}" style="font-weight: bold;">
                                ${estChargeChange > 0 ? '↑' : estChargeChange < 0 ? '↓' : '→'} 
                                Rs. ${Math.abs(estChargeChange).toFixed(2)}
                                ${estChargeChange !== 0 ? `<span style="font-size: 0.75rem; margin-left: 8px;">(${estChargePercent}%)</span>` : ''}
                            </span>
                        </div>
                        <div class="comparison-item">
                            <span style="font-size: 0.9rem;">Total Meals Change:</span>
                            <span style="font-weight: bold;">
                                ${mealsChange > 0 ? '↑' : mealsChange < 0 ? '↓' : '→'} 
                                ${Math.abs(mealsChange)} meals
                            </span>
                        </div>
                    </div>
                </div>
            `;
        }

        init();
    </script>
</body>
</html>